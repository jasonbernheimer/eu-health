---
title: "Data_Sources"
author: "Jason Bernheimer"
date: "2/1/2021"
output: html_document
---

```{r setup, include=TURE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
library(ggplot2)
library(ggvis)
library(ggthemes)
library(RColorBrewer)
library(scales)
library(readr)
library(skimr)
library(janitor)
library(forcats)
library(tidyr)
library(lubridate)
library(stringr)
library(assertive.types)
library(assertive)
library(visdat)
library(fuzzyjoin)
library(stringdist)
library(reclin)

# Data
library(OECD)
```

## OECD Data

```{r}
OECD::search_dataset("Health")
```

```{r eval=FALSE, include=TRUE}
# this is to get the data from OECD and save it to the directory
# dont run this code unless there are issues with the data

#     df <- OECD::get_dataset("HEALTH_REAC")
#     save(df, file = "healthdata.Rdata")
```

```{r}
# load data since it has already been saved in the project directory
load("healthdata.Rdata")
head(df, 10)
```

```{r}
# Data Definitions
OECD::get_data_structure("HEALTH_REAC")

key <- get_data_structure("HEALTH_REAC")

key_VAR <- key[["VAR"]]
key_UNIT <- key[["UNIT"]]
```


Ignore this chunk:
```{r}
# USE ALL OECD COUNTRIES FOR NOW
# countries <- unique(df$COU)
# 
# COU_exclude <- c("AUS", "CAN", "ISR", "JPN", "KOR", "MEX", "NZL", "USA", "BRA", "CHL", "CHN", "IND", "IDN", "RUS", "ZAF", "COL", "CRI")
```

```{r}
# select only 2019 for ease of use for now
mydata <- df %>%
  filter(obsTime == 2019)

# GPs
mydata %>%
  filter(VAR == "EMPLGENE" |VAR == "EMPLGENP"|VAR ==  "EMPLOTGP") %>%
  filter(UNIT == "PERSMYNB" | UNIT == "PERMEDNB")
key_UNIT %>%
  filter(id == c("PERSMYNB", "PERMEDNB"))

# Specialists
mydata %>%
  filter(VAR == "EMPLSPMP" |VAR == "EMPLGENP"|VAR ==  "EMPLOTGP") %>%
  filter(UNIT == "PERSMYNB" | UNIT == "PERMEDNB")

```


Things to note about Physicians: 

* `VAR` = `EMPLGENE`
  + this is all that is needed because it is the combined general practitioners and will mitigate slight differences in deffinitions between the two sub categories `EMPLGENP` & `EMPLOTGP` or which `EMPLGENE` is the sum of the two.
* `UNIT`
  + `PERSMYNB` - Number of persons (head counts)
  + `PERMEDNB` - % of physicians (head counts)
    + this is impacted by `EMPLOTPH` so I will have to calculate my own percentages between **specified** GPs and Specialists rather than all doctors.

`VAR`:

* `EMPLOTPH` - Medical doctors not further defined

**are paediatricians specialists?** They are defined as specialists in the data but maybe we should change that?


```{r}
temp <- df %>%
  filter(obsTime == 2015) 

temp <- mutate(temp, COU = as.factor(COU))

levels(temp$COU)
```

Years 2015, 2016, & 2017 all have 43 of the 44 countries total. 

2017 is missing the *Czech Republic* and *Finland*, be sure to exclude *Russia*, *Indonesia*, and *South Africa* because they don't have full data.


Now that I understand the data, let's make something actually useful:
```{r}
mydata <- df %>%
  filter(obsTime == 2017) %>%
  dplyr::select(-TIME_FORMAT)



countries_no_data <- c("ZAF", "CZE", "FIN", "CHN", "IDN", "IND", "BRA", "JPN", "SVK")
countries_keep <- c("AUS", "AUT", "BEL", "CAN", "CHE", "CHL", "CRI", "DEU", "DNK", "ESP", "EST", "FRA", "GBR", "GRC", "HUN", "IRL", "ISL", "ISR", "ITA", "KOR", "LTU", "LUX", "LVA", "MEX", "NLD", "NOR", "NZL", "POL", "PRT", "SVN", "SWE", "TUR", "USA")

mydata <- mydata %>%
  filter(COU == countries_keep)


mydata <- mydata %>%
  filter(COU != "ZAF" & COU != "CZE" & COU != "FIN" & COU != "CHN" & COU != "IDN" & COU != "IND" & COU != "BRA" & COU != "JPN" & COU != "SVK")

mydata <- mutate(mydata, COU = as.factor(COU))

mydata <- mydata %>%
  filter(COU == countries_keep)

countries_keep <- as.factor(countries_keep)

t <- levels(mydata$COU)
t
```


















## Eurostat

```{r}
library(eurostat)
```

What functions are in the Eurostat package?

| Function | Explanation |
|----|--------------|
|add_nuts_level|Add the statistical aggregation level to data frame|
|check_access_to_data | Check access to ec.europe.eu|
|clean_eurostat_cache | Clean Eurostat Cache|
|cut_to_classes | Cuts the Values Column into Classes and Polishes the Labels|
|dic_order | Order of Variable Levels from Eurostat Dictionary.|
|eu_countries | Countries and Country Codes|
|eurostat_geodata_60_2016| Geospatial data of Europe from Gisco in 1:60 million scale from year 2016|
|eurostat-package  | R Tools for Eurostat open data|
|eurotime2date  | Date Conversion from Eurostat Time Format|
|eurotime2num  |Conversion of Eurostat Time Format to Numeric|
|get_bibentry | Create A Data Bibliography|
|get_eurostat  |Read Eurostat Data|
|get_eurostat_dic  | Download Eurostat Dictionary|
|get_eurostat_geospatial | Download Geospatial Data from GISCO|
|get_eurostat_json| Get Data from Eurostat API in JSON|
|get_eurostat_raw  |Download Data from Eurostat Database|
|get_eurostat_toc |Download Table of Contents of Eurostat Data Sets|
|harmonize_country_code| Harmonize Country Code|
|harmonize_geo_code |Harmonize NUTS region codes that changed with the 'NUTS2016' definition|
|label_eurostat |Get Eurostat Codes|
|nuts_correspondence| Correspondence Table NUTS2013-NUTS2016|
|recode_to_nuts_2013 |Recode geo labels and rename regions from NUTS2016 to NUTS2013|
|recode_to_nuts_2016 |Recode geo labels and rename regions from NUTS2013 to NUTS2016|
|regional_changes_2016 |Changes in regional boundaries NUTS2013-NUTS2016|
|search_eurostat| Grep Datasets Titles from Eurostat|
|tgs00026| Auxiliary Data|

```{r}
toc <- get_eurostat_toc()

toc
```

```{r}

```


Indicators: 
HIHSI062004 - Current health care expenditure by all financing agents (total), as percentage of GDP 
HIHSI062005 - Current health care expenditure by public sector, as percentage of GDP 
HIHSI062007 - Current health care expenditure by household out-of-pocket payment, as percentage of GDP 
HIHSI062008 - Current health care expenditure by voluntary health care payment schemes, as percentage of GDP 
HIHSI063004 - Current health care expenditure by all financing agents, in millions of PPS 
HIHSI063005 - Current health care expenditure by public sector, in millions of PPS 
HIHSI063007 - Current health care expenditure by household out-of-pocket payment, in millions of PPS 
HIHSI063008 - Current health care expenditure by voluntary health care payment schemes, in millions of PPS 

